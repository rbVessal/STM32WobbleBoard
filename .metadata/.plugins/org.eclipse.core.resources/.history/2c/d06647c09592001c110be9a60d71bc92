/*
 * WobbleBoardApp.cpp
 *
 *  Created on: Feb 19, 2022
 *      Author: Beca Vessal
 */

#include "WobbleBoardApp.h"

#include "motion_fx_manager.h"
#include "com.h"

#define ALGO_FREQ  100U /* Algorithm frequency 100Hz */
#define ACC_ODR  ((float)ALGO_FREQ)
#define ACC_FS  4 /* FS = <-4g, 4g> */
#define ALGO_PERIOD  (1000U / ALGO_FREQ) /* Algorithm period [ms] */
#define FROM_UT50_TO_MGAUSS  500.0f

WobbleBoardApp::WobbleBoardApp()
{
	// TODO Auto-generated constructor stub

}

void WobbleBoardApp::Init()
{
	InitInertialSensors();

	// Sensor Fusion API initialization function
	MotionFX_manager_init();

	//Enable magnetometer calibration
	MotionFX_manager_MagCal_start(ALGO_PERIOD);

	/* Test if calibration data are available */
	MFX_MagCal_output_t mag_cal_test;
	MotionFX_MagCal_getParams(&mag_cal_test);

	// If calibration data are available load HI coefficients
	if (mag_cal_test.cal_quality == MFX_MAGCALGOOD)
	{
		float ans_float;
		ans_float = (mag_cal_test.hi_bias[0] * FROM_UT50_TO_MGAUSS);
		MagOffset.x = (int32_t)ans_float;
		ans_float = (mag_cal_test.hi_bias[1] * FROM_UT50_TO_MGAUSS);
		MagOffset.y = (int32_t)ans_float;
		ans_float = (mag_cal_test.hi_bias[2] * FROM_UT50_TO_MGAUSS);
		MagOffset.z = (int32_t)ans_float;

		MagCalStatus = 1;
	}

	// Start receiving messages via DMA
	UART_StartReceiveMsg();
}

void WobbleBoardApp::InitInertialSensors()
{
	BSP_SENSOR_ACC_Init();
	BSP_SENSOR_GYR_Init();
	BSP_SENSOR_MAG_Init();

	BSP_SENSOR_ACC_SetOutputDataRate(ACC_ODR);
	BSP_SENSOR_ACC_SetFullScale(ACC_FS);
}

void WobbleBoardApp::Process()
{
	TMsg msg_dat;
	TMsg msg_cmd;

	if (UART_ReceivedMSG((TMsg *)&msg_cmd) == 1)
	{
		if (msg_cmd.Data[0] == DEV_ADDR)
		{
		  (void)HandleMSG((TMsg *)&msg_cmd);
		}
	}

	if (MagCalRequest == 1U)
	{
		MagCalRequest = 0;

		/* Reset magnetometer calibration value*/
		MagCalStatus = 0;
		MagOffset.x = 0;
		MagOffset.y = 0;
		MagOffset.z = 0;

		/* Enable magnetometer calibration */
		MotionFX_manager_MagCal_start(ALGO_PERIOD);
	}

	if (SensorReadRequest == 1U)
	{
		SensorReadRequest = 0;

		/* Acquire data from enabled sensors and fill Msg stream */
		//RTC_Handler(&msg_dat);
		Accelero_Sensor_Handler(&msg_dat);
		Gyro_Sensor_Handler(&msg_dat);
		Magneto_Sensor_Handler(&msg_dat);

		/* Sensor Fusion specific part */
		FX_Data_Handler(&msg_dat);

		/* Send data stream */
		INIT_STREAMING_HEADER(&msg_dat);
		msg_dat.Len = STREAMING_MSG_LENGTH;
	}
	UART_SendMsg(&msg_dat);
}

void WobbleBoardApp::Accelero_Sensor_Handler(TMsg* msg)
{
	if ((SensorsEnabled & ACCELEROMETER_SENSOR) == ACCELEROMETER_SENSOR)
	{

		BSP_SENSOR_ACC_GetAxes(&AccValue);

		Serialize_s32(&Msg->Data[19], (int32_t)AccValue.x, 4);
		Serialize_s32(&Msg->Data[23], (int32_t)AccValue.y, 4);
		Serialize_s32(&Msg->Data[27], (int32_t)AccValue.z, 4);
	}
}

void WobbleBoardApp::Gyro_Sensor_Handler(TMsg* msg)
{
	if ((SensorsEnabled & GYROSCOPE_SENSOR) == GYROSCOPE_SENSOR)
	{
		BSP_SENSOR_GYR_GetAxes(&GyrValue);

		Serialize_s32(&Msg->Data[31], GyrValue.x, 4);
		Serialize_s32(&Msg->Data[35], GyrValue.y, 4);
		Serialize_s32(&Msg->Data[39], GyrValue.z, 4);
	}
}

void WobbleBoardApp::Magneto_Sensor_Handler(TMsg& msg)
{
	float ans_float;
	MFX_MagCal_input_t mag_data_in;
	MFX_MagCal_output_t mag_data_out;

	if ((SensorsEnabled & MAGNETIC_SENSOR) == MAGNETIC_SENSOR)
	{
		BSP_SENSOR_MAG_GetAxes(&MagValue);

		if (MagCalStatus == 0U)
		{
			mag_data_in.mag[0] = (float)MagValue.x * FROM_MGAUSS_TO_UT50;
			mag_data_in.mag[1] = (float)MagValue.y * FROM_MGAUSS_TO_UT50;
			mag_data_in.mag[2] = (float)MagValue.z * FROM_MGAUSS_TO_UT50;

			mag_data_in.time_stamp = (int)TimeStamp;
			TimeStamp += (uint32_t)ALGO_PERIOD;

			MotionFX_manager_MagCal_run(&mag_data_in, &mag_data_out);

			if (mag_data_out.cal_quality == MFX_MAGCALGOOD)
			{
				MagCalStatus = 1;

				ans_float = (mag_data_out.hi_bias[0] * FROM_UT50_TO_MGAUSS);
				MagOffset.x = (int32_t)ans_float;
				ans_float = (mag_data_out.hi_bias[1] * FROM_UT50_TO_MGAUSS);
				MagOffset.y = (int32_t)ans_float;
				ans_float = (mag_data_out.hi_bias[2] * FROM_UT50_TO_MGAUSS);
				MagOffset.z = (int32_t)ans_float;

				/* Disable magnetometer calibration */
				MotionFX_manager_MagCal_stop(ALGO_PERIOD);
			}
		}

		MagValue.x = (int32_t)(MagValue.x - MagOffset.x);
		MagValue.y = (int32_t)(MagValue.y - MagOffset.y);
		MagValue.z = (int32_t)(MagValue.z - MagOffset.z);

		Serialize_s32(&Msg->Data[43], MagValue.x, 4);
		Serialize_s32(&Msg->Data[47], MagValue.y, 4);
		Serialize_s32(&Msg->Data[51], MagValue.z, 4);
	}
}

void WobbleBoardApp::FX_Data_Handler(TMsg* Msg)
{

}

//WobbleBoardApp::~WobbleBoardApp()
//{
//	// TODO Auto-generated destructor stub
//}

