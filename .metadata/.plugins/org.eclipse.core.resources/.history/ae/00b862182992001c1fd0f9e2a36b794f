/*
 * WobbleBoardApp.cpp
 *
 *  Created on: Feb 19, 2022
 *      Author: Beca Vessal
 */

#include "WobbleBoardApp.h"

#include "motion_fx_manager.h"
#include "com.h"

#define ALGO_FREQ  100U /* Algorithm frequency 100Hz */
#define ACC_ODR  ((float)ALGO_FREQ)
#define ACC_FS  4 /* FS = <-4g, 4g> */
#define ALGO_PERIOD  (1000U / ALGO_FREQ) /* Algorithm period [ms] */
#define FROM_UT50_TO_MGAUSS  500.0f

WobbleBoardApp::WobbleBoardApp()
{
	// TODO Auto-generated constructor stub

}

void WobbleBoardApp::Init()
{
	InitInertialSensors();

	// Sensor Fusion API initialization function
	MotionFX_manager_init();

	//Enable magnetometer calibration
	MotionFX_manager_MagCal_start(ALGO_PERIOD);

	/* Test if calibration data are available */
	MFX_MagCal_output_t mag_cal_test;
	MotionFX_MagCal_getParams(&mag_cal_test);

	// If calibration data are available load HI coefficients
	if (mag_cal_test.cal_quality == MFX_MAGCALGOOD)
	{
		float ans_float;
		ans_float = (mag_cal_test.hi_bias[0] * FROM_UT50_TO_MGAUSS);
		MagOffset.x = (int32_t)ans_float;
		ans_float = (mag_cal_test.hi_bias[1] * FROM_UT50_TO_MGAUSS);
		MagOffset.y = (int32_t)ans_float;
		ans_float = (mag_cal_test.hi_bias[2] * FROM_UT50_TO_MGAUSS);
		MagOffset.z = (int32_t)ans_float;

		MagCalStatus = 1;
	}

	// Start receiving messages via DMA
	UART_StartReceiveMsg();
}

void WobbleBoardApp::InitInertialSensors()
{
	BSP_SENSOR_ACC_Init();
	BSP_SENSOR_GYR_Init();
	BSP_SENSOR_MAG_Init();

	BSP_SENSOR_ACC_SetOutputDataRate(ACC_ODR);
	BSP_SENSOR_ACC_SetFullScale(ACC_FS);
}

void WobbleBoardApp::Process()
{
	TMsg msg_dat;
	TMsg msg_cmd;

	if (UART_ReceivedMSG((TMsg *)&msg_cmd) == 1)
	{
		if (msg_cmd.Data[0] == DEV_ADDR)
		{
		  (void)HandleMSG((TMsg *)&msg_cmd);
		}
	}

	if (MagCalRequest == 1U)
	{
	/* Debouncing */
	HAL_Delay(50);

	/* Wait until the button is released */
	while ((BSP_PB_GetState( BUTTON_KEY ) == PushButtonState));

	/* Debouncing */
	HAL_Delay(50);

	MagCalRequest = 0;

	/* Reset magnetometer calibration value*/
	MagCalStatus = 0;
	MagOffset.x = 0;
	MagOffset.y = 0;
	MagOffset.z = 0;

	/* Enable magnetometer calibration */
	MotionFX_manager_MagCal_start(ALGO_PERIOD);
	}

	if (SensorReadRequest == 1U)
	{
	SensorReadRequest = 0;

	/* Acquire data from enabled sensors and fill Msg stream */
	RTC_Handler(&msg_dat);
	Accelero_Sensor_Handler(&msg_dat);
	Gyro_Sensor_Handler(&msg_dat);
	Magneto_Sensor_Handler(&msg_dat);
	Humidity_Sensor_Handler(&msg_dat);
	Temperature_Sensor_Handler(&msg_dat);
	Pressure_Sensor_Handler(&msg_dat);

	/* Sensor Fusion specific part */
	FX_Data_Handler(&msg_dat);

	/* Send data stream */
	INIT_STREAMING_HEADER(&msg_dat);
	msg_dat.Len = STREAMING_MSG_LENGTH;

	if (UseOfflineData == 1U)
	{
	  OfflineDataCount--;
	  if (OfflineDataCount < 0)
	  {
		OfflineDataCount = 0;
	  }

	  OfflineDataReadIndex++;
	  if (OfflineDataReadIndex >= OFFLINE_DATA_SIZE)
	  {
		OfflineDataReadIndex = 0;
	  }

	  if (OfflineDataCount > 0)
	  {
		SensorReadRequest = 1;
	  }
	}
	UART_SendMsg(&msg_dat);
}

//WobbleBoardApp::~WobbleBoardApp()
//{
//	// TODO Auto-generated destructor stub
//}

